{"files":[{"id":"18111fd6-1e66-4a94-9cc6-169b1098a9ef","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Ho_Chi_Minh\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"91ab7f1b-47e4-49aa-a696-75887bcf8258","name":"code","type":"server_js","source":"const token \u003d \"6304158730:AAEFEqCH8tnrbI-HRCjuQGC3aYWRklbJqKQ\";\nconst teleUrl \u003d \"https://api.telegram.org/bot\" + token;\nconst webAppUrl \u003d\n\"https://script.google.com/macros/s/AKfycbwaMX1z_ZvEeVulL1B12oA6lbqvlG2vp_bbhWbDUlWQMuFRdES1yJKGMJdkH83Ut40/exec\";\n\nconst SSID \u003d \"1kn8fAW5g6SKe1hV5Qfh_SVpF8wTNNNsvQw2Q5HdrGyM\"; //sub-url spreadsheet\nlet sheetName \u003d \"spending\";\ndataInit \u003d [\"Ngày\", \"Danh mục\", \"Giá\",\"Chi chú\", \" \", \"Tổng\"]\n\nfunction initSheet() {  \n  const dataLength \u003d dataInit.length\n  if (dataLength \u003d\u003d 0) {\n    return\n  }\n\n  const sheet \u003d SpreadsheetApp.openById(SSID).getSheetByName(sheetName)\n  const checkEmptySheet \u003d sheet.getLastRow()\n\n  // init template\n  if (checkEmptySheet \u003d\u003d 0) {\n    sheet.appendRow(dataInit);\n\n    const greenColor \u003d \u0027#b6d7a8\u0027\n    sheet.getRange(\"A1:D1\").setBackground(greenColor)\n  }\n}\n\nfunction setWebhook() {\n    const url \u003d teleUrl + \"/setWebhook?url\u003d\" + webAppUrl\n    const response \u003d UrlFetchApp.fetch(url);\n\n    Logger.log(response.getContentText());\n}\n\nfunction doPost(e) {\n    const stringJson \u003d e.postData.getDataAsString();\n    var updates \u003d JSON.parse(stringJson);\n    var id \u003d updates.message.from.id;\n    var textBot \u003d updates.message.text;\n    var chat_bot \u003d textBot;\n    var command_cek \u003d chat_bot.substring(0, 1);\n    var command \u003d chat_bot.split(\" \")[0]; // command\n\n    if (command_cek \u003d\u003d \"/\") {\n        switch (command) {\n            case \"/start\":\n                let text1 \u003d \"Khởi chạy bot thành công!\";\n                sendText(id, text1);\n                break;\n            case \"/help\":\n                let text2 \u003d \"*Cú pháp\\n\"+\n                            \"Thêm chi tiêu: /add ::danh mục::giá tiền::ghi chú \\n\" + \n                            \"BC chi tiêu: /report ::tháng::năm \\n\";\n                sendText(id, text2);\n                break;\n            case \"/add\":\n                add(updates);\n                break;\n            case \"/report\":\n                report(updates);\n                break;\n            default:\n                sendText(\n                    id,\n                    \"Lệnh này chưa được thiết lập !!!\"\n                );\n        }\n    } else {\n        let error \u003d \"Lỗi cú pháp!!!\";\n        sendText(id, error);\n    }\n}\n\nfunction add(data) {\n    const id \u003d data.message.from.id;\n    const text \u003d data.message.text;\n    const textArray \u003d text.split(\"::\")\n\n    if (textArray.length !\u003d\u003d 4) {\n      sendText(id, \"Chưa điền đủ thông tin!!!\");\n      return\n    }\n\n    const now \u003d new Date();\n    const time \u003d Utilities.formatDate(now, \"GMT+07:00\", \"dd/MM/yyyy hh:mm:ss\"); // format timestamp\n\n    const description \u003d textArray[1]; \n    const total \u003d textArray[2]; \n    const note \u003d textArray[3]; \n\n    SpreadsheetApp\n      .openById(SSID)\n      .getSheetByName(sheetName)\n      .appendRow([time, description, total, note]); // input log\n\n    sendText(id, \"Chi tiêu đã được lưu lại!\");\n}\n\nfunction report(data) {\n  const id \u003d data.message.from.id;\n  const text \u003d data.message.text;\n  textArray \u003d text.split(\"::\")\n\n  if (textArray.length !\u003d\u003d 3) {\n    sendText(id, \"Chưa điền đủ thông tin!!!\");\n    return\n  }\n\n  const month \u003d textArray[1];\n  // const year \u003d textArray[2];\n  const total \u003d SpreadsheetApp.openById(SSID).getSheetByName(sheetName).getRange(\u0027G1\u0027).getValue()\n    \n  sendText(id, `Tổng chi tiêu tháng ${month} là: ${total}`)\n}\n\nfunction sendText(chatid, text, replymarkup) {\n    const data \u003d {\n        method: \"post\",\n        payload: {\n            method: \"sendMessage\",\n            chat_id: String(chatid),\n            text: text,\n            parse_mode: \"HTML\",\n            reply_markup: JSON.stringify(replymarkup),\n        },\n    };\n    UrlFetchApp.fetch(\"https://api.telegram.org/bot\" + token + \"/\", data);\n}\n"}]}